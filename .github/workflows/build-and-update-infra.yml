name: Build image and update pms-infra

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_HOST }} # e.g. docker.io or <aws_account_id>.dkr.ecr.<region>.amazonaws.com
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Clone infra repo
        env:
          INFRA_TOKEN: ${{ secrets.INFRA_REPO_TOKEN }}
        run: |
          git clone https://x-access-token:${INFRA_TOKEN}@github.com/pms-org/pms-infra.git infra

      - name: Install yq
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Update infra kustomization (images.newTag)
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IMAGE_REPO: ${{ secrets.IMAGE_REPO }}
        run: |
          cd infra/services/trade-capture
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git checkout -b bump/trade-capture/${IMAGE_TAG}
          # Update the image tag in kustomization.yaml (CI contract)
          yq e '.images[0].newTag = strenv(IMAGE_TAG)' -i kustomization.yaml
          git add kustomization.yaml
          git commit -m "ci(trade-capture): bump image to ${IMAGE_REPO}:${IMAGE_TAG}"
          git push origin HEAD

      - name: Open PR against infra (optional)
        if: always()
        env:
          INFRA_TOKEN: ${{ secrets.INFRA_REPO_TOKEN }}
        run: |
          BRANCH=$(git -C infra rev-parse --abbrev-ref HEAD)
          curl -s -X POST -H "Authorization: token ${INFRA_TOKEN}" -H "Accept: application/vnd.github+json" \
            -d "{\"title\":\"chore(trade-capture): bump image to ${IMAGE_TAG}\",\"head\":\"${BRANCH}\",\"base\":\"main\"}" \
            https://api.github.com/repos/pms-org/pms-infra/pulls

# Secrets required by this workflow:
# - REGISTRY_HOST: registry host (docker.io or ECR hostname)
# - REGISTRY_USERNAME / REGISTRY_PASSWORD: credentials for the container registry
# - IMAGE_REPO: full image name (e.g. niishantdev/pms-trade-capture or <account>.dkr.ecr.<region>.amazonaws.com/pms-trade-capture)
# - INFRA_REPO_TOKEN: Personal access token with repo:status and repo permissions for `pms-org/pms-infra`
